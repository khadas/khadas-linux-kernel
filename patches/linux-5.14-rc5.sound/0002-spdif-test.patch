From 4e870997a0b1e362514cb4f725cb05265b3a4154 Mon Sep 17 00:00:00 2001
From: Artem Lapkin <art@khadas.com>
Date: Wed, 11 Aug 2021 10:19:24 +0800
Subject: [PATCH 2/2] spdif test

Signed-off-by: Artem Lapkin <art@khadas.com>
---
 .../boot/dts/amlogic/meson-khadas-vim3.dtsi   | 49 ++++++++++++++++++-
 1 file changed, 47 insertions(+), 2 deletions(-)

diff --git a/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi b/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi
index 3cf4ecb6d..f44da7e6b 100644
--- a/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi
+++ b/arch/arm64/boot/dts/amlogic/meson-khadas-vim3.dtsi
@@ -167,6 +167,12 @@ hdmi_connector_in: endpoint {
 		};
 	};
 
+	spdif_dit: audio-codec-1 {
+		#sound-dai-cells = <0>;
+		compatible = "linux,spdif-dit";
+		status = "okay";
+		sound-name-prefix = "DIT";
+	};
 
 	sound {
 		compatible = "amlogic,axg-sound-card";
@@ -180,7 +186,10 @@ sound {
 				"TDMIN_A IN 3", "TDM_A Loopback",
 				"TODDR_A IN 0", "TDMIN_A OUT",
 				"TODDR_B IN 0", "TDMIN_A OUT",
-				"TODDR_C IN 0", "TDMIN_A OUT";
+				"TODDR_C IN 0", "TDMIN_A OUT",
+				"SPDIFOUT IN 0", "FRDDR_A OUT 3",
+				"SPDIFOUT IN 1", "FRDDR_B OUT 3",
+				"SPDIFOUT IN 2", "FRDDR_C OUT 3";
 
 		assigned-clocks = <&clkc CLKID_MPLL2>,
 				  <&clkc CLKID_MPLL0>,
@@ -230,8 +239,30 @@ codec {
 			};
 		};
 
+	/* spdif hdmi or toslink interface */
+	dai-link-7 {
+	    sound-dai = <&spdifout>;
+
+	    codec-0 {
+		sound-dai = <&spdif_dit>;
+	    };
+
+	    codec-1 {
+		sound-dai = <&tohdmitx TOHDMITX_SPDIF_IN_A>;
+	    };
+	};
+
+	/* spdif hdmi interface */
+	dai-link-8 {
+	    sound-dai = <&spdifout_b>;
+
+	    codec {
+		sound-dai = <&tohdmitx TOHDMITX_SPDIF_IN_B>;
+	    };
+	};
+
 		/* hdmi glue */
-		dai-link-7 {
+		dai-link-9 {
 			sound-dai = <&tohdmitx TOHDMITX_I2S_OUT>;
 
 			codec {
@@ -323,6 +354,8 @@ &frddr_c {
 &hdmi_tx {
 	status = "okay";
 	pinctrl-0 = <&hdmitx_hpd_pins>, <&hdmitx_ddc_pins>;
+//, <&i2s_out_ch01_pins>, <&i2s_out_lr_clk_pins>, <&i2s_out_ao_clk_pins>;
+//	pinctrl-0 = <&hdmitx_hpd_pins>, <&hdmitx_ddc_pins>, <&i2s_out_ch01_pins>, <&i2s_out_lr_clk_pins>, <&i2s_out_ao_clk_pins>;
 	pinctrl-names = "default";
 	hdmi-supply = <&vcc_5v>;
 };
@@ -333,6 +366,18 @@ hdmi_tx_tmds_out: endpoint {
 	};
 };
 
+&spdifout {
+    pinctrl-0 = <&spdif_out_h_pins>, <&spdif_ao_out_pins>, <&spdif_out_a11_pins>, <&spdif_out_a13_pins>;
+    //pinctrl-0 = <&spdif_out_h_pins>, <&i2s_out_ch01_pins>, <&i2s_out_lr_clk_pins>, <&i2s_out_ao_clk_pins>;
+    pinctrl-names = "default";
+    status = "okay";
+};
+
+&spdifout_b {
+    status = "okay";
+};
+
+
 &i2c_AO {
 	status = "okay";
 	pinctrl-0 = <&i2c_ao_sck_pins>, <&i2c_ao_sda_pins>;
-- 
2.25.1

